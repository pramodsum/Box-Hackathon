<!DOCTYPE html>
<html style="background: white">
  <head>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Box Arcade</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://staging.flappybird.io/assets/app-c77d11cf36a401a7679b32e53dc0c5b1.css">
    <link rel="stylesheet" href="css/custom.css">
    <script src="js/create.min.js"></script>
	<script src="js/preload.js"></script>
    <script src="app.js"></script>
    <script src="https://cdn.firebase.com/js/client/1.0.19/firebase.js"></script>
    <script type="text/javascript">
        

  var LEADERBOARD_SIZE = 5;

  // Build some firebase references.
  var rootRef = new Firebase('https://flappyboxercopter.firebaseio.com/');
  var scoreListRef = rootRef.child("scoreboard");
  var highestScoreRef = rootRef.child("highestScore");

  // Keep a mapping of firebase locations to HTML elements, so we can move / remove elements as necessary.
  var htmlForPath = {};

  // Helper function that takes a new score snapshot and adds an appropriate row to our leaderboard table.
  function handleScoreAdded(scoreSnapshot, prevScoreName) {
    var newScoreRow = $("<tr/>");
    newScoreRow.append($("<td/>").append($("<em/>").text(scoreSnapshot.val().fullname)));
    newScoreRow.append($("<td/>").text(scoreSnapshot.val().email));
    newScoreRow.append($("<td/>").text(scoreSnapshot.val().score));

    // Store a reference to the table row so we can get it again later.
    htmlForPath[scoreSnapshot.name()] = newScoreRow;

    // Insert the new score in the appropriate place in the table.
    if (prevScoreName === null) {
      $("#leaderboardTable").append(newScoreRow);
    }
    else {
      var lowerScoreRow = htmlForPath[prevScoreName];
      lowerScoreRow.before(newScoreRow);
    }
    
    var newScore = scoreSnapshot.val().score;
//    console.log(highestScoreRef.val());
    // Track the highest score using a transaction.  A transaction guarantees that the code inside the block is
    // executed on the latest data from the server, so transactions should be used if you have multiple
    // clients writing to the same data and you want to avoid conflicting changes.
    highestScoreRef.transaction(function (currentHighestScore) {
    if (currentHighestScore === null || newScore > currentHighestScore) {
      // The return value of this function gets saved to the server as the new highest score.
      return newScore;
    }
    // if we return with no arguments, it cancels the transaction.
    return;
    });
  }

  // Helper function to handle a score object being removed; just removes the corresponding table row.
  function handleScoreRemoved(scoreSnapshot) {
    var removedScoreRow = htmlForPath[scoreSnapshot.name()];
    removedScoreRow.remove();
    delete htmlForPath[scoreSnapshot.name()];
  }

  // Create a view to only receive callbacks for the last LEADERBOARD_SIZE scores
  var scoreListView = scoreListRef.limit(LEADERBOARD_SIZE);

  // Add a callback to handle when a new score is added.
  scoreListView.on('child_added', function (newScoreSnapshot, prevScoreName) {
    handleScoreAdded(newScoreSnapshot, prevScoreName);
  });

  // Add a callback to handle when a score is removed
  scoreListView.on('child_removed', function (oldScoreSnapshot) {
    handleScoreRemoved(oldScoreSnapshot);
  });

  // Add a callback to handle when a score changes or moves positions.
  var changedCallback = function (scoreSnapshot, prevScoreName) {
    handleScoreRemoved(scoreSnapshot);
    handleScoreAdded(scoreSnapshot, prevScoreName);
  };
  scoreListView.on('child_moved', changedCallback);
  scoreListView.on('child_changed', changedCallback);

  // Add a callback to the highest score in Firebase so we can update the GUI any time it changes.
  highestScoreRef.on('value', function (newHighestScore) {
    $("#highestScoreDiv").text(newHighestScore.val());
  });
        var outerPadding = 0
        $(function() {
            init()
            $( "canvas" ).on( "gameEnd", function(e) {
                console.log('game over')
            });
            $( "canvas").trigger( "gameEnd");

        })
    </script>
  </head>
  <body style="background: white;">
    <!-- Static navbar -->
    <div class="navbar navbar-default" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Box Arcade</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../mario/index.html">Super Aaron</a></li>
            <li><a href="#">Flappy Aaron</a></li>
            <li><a href="../cloud-runner/index.html">Cloud Runner</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div><!--/.container-fluid -->
    </div>

    <center>
      <h4><strong>Current High Score: </strong><span id="highestScoreDiv"></span></h4>
      <div class="row" ng-app="leaderboard">
        <div class="col-md-6">
          <canvas id="testCanvas" width="768" height="1024"> </canvas>
        </div>
        <div class="col-md-6">
          <h4><strong>Leaderboard</strong></h4>
          <div class="">
              <table class="table" id="leaderboardTable"></table>
          </div>
        </div>
      </div>
    </center>
    <br>

    <script src="libs/jquery.min.js"></script>
    <script src="libs/bootstrap.min.js"></script>
    <script src="libs/sugar.custom.js"></script>
  </body>
</html>
